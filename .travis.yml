language: generic
cache:
  # Cache the global cargo directory, but NOT the local `target` directory which
  # we cannot reuse anyway when the nightly changes (and it grows quite large
  # over time).
  directories:
    - /home/travis/.cargo

os:
- linux
dist: xenial

before_script:
- sudo apt-get -y install moreutils
# Compute the Rust version we use. We do not use "language: rust" to have more control here.
- |
  if [[ "$TRAVIS_EVENT_TYPE" == cron ]]; then
    RUST_TOOLCHAIN=nightly-$(curl -s https://rust-lang.github.io/rustup-components-history/x86_64-unknown-linux-gnu/miri)
  else
    RUST_TOOLCHAIN=$(cat rust-version)
  fi
- 'echo "Installing Rust version: $RUST_TOOLCHAIN"'
# install Rust
- 'curl -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain "$RUST_TOOLCHAIN" --profile minimal --component rust-src --component miri'
- export PATH=$HOME/.cargo/bin:$PATH
- rustc --version

script:
- ./travis.sh

notifications:
  email:
    on_success: never
    recipients:
      - post+travis@ralfj.de
      - travis-miri@oli-obk.de
branches:
  only:
  - master
